// ===== BioShield Biometric Monitoring Hook =====
// This script hooks Android biometric authentication APIs
// and logs events in encrypted format for security analysis

console.log('[BioShield] Loading hook script...');

// Encryption key (AES-256-GCM, Base64 encoded)
const AES_KEY_B64 = "W7Yy9Np3F2e8Dqz0pY6Qv0T92oLk12BxVZtq8lZhg7s=";
const IV = [0,0,0,0,0,0,0,0,0,0,0,0]; // 12 bytes of zeros

// Log file path
const LOG_PATH = "/storage/emulated/0/Download/BioShield/logs.jsonl";

// Initialize hooks when Java is ready
Java.perform(function() {
    console.log('[BioShield] Java.perform() started');

    try {
        // Hook androidx.biometric.BiometricPrompt
        hookBiometricPrompt();

        // Hook legacy FingerprintManager (for older implementations)
        hookFingerprintManager();

        // Create log directory
        createLogDirectory();

        console.log('[BioShield] ✓ All hooks initialized successfully');
    } catch (error) {
        console.error('[BioShield] ✗ Hook initialization failed:', error.message);
        console.error('[BioShield] Stack trace:', error.stack);
    }
});

// ===== Hook androidx.biometric.BiometricPrompt =====
function hookBiometricPrompt() {
    try {
        const BiometricPrompt = Java.use('androidx.biometric.BiometricPrompt');
        console.log('[BioShield] Found androidx.biometric.BiometricPrompt');

        // Hook authenticate() with PromptInfo only
        BiometricPrompt.authenticate.overload('androidx.biometric.BiometricPrompt$PromptInfo').implementation = function(promptInfo) {
            console.log('[BioShield] [HOOK] BiometricPrompt.authenticate() called (no crypto)');

            writeLog({
                event: 'androidx_auth_started',
                timestamp: Date.now(),
                hasCrypto: false,
                method: 'BiometricPrompt'
            });

            return this.authenticate(promptInfo);
        };

        // Hook authenticate() with CryptoObject
        BiometricPrompt.authenticate.overload(
            'androidx.biometric.BiometricPrompt$PromptInfo',
            'androidx.biometric.BiometricPrompt$CryptoObject'
        ).implementation = function(promptInfo, cryptoObject) {
            console.log('[BioShield] [HOOK] BiometricPrompt.authenticate() called (WITH crypto)');

            writeLog({
                event: 'androidx_auth_started',
                timestamp: Date.now(),
                hasCrypto: true,
                method: 'BiometricPrompt'
            });

            return this.authenticate(promptInfo, cryptoObject);
        };

        // Hook AuthenticationCallback
        const Callback = Java.use('androidx.biometric.BiometricPrompt$AuthenticationCallback');

        Callback.onAuthenticationSucceeded.implementation = function(result) {
            console.log('[BioShield] [EVENT] ✓ Authentication SUCCEEDED');

            writeLog({
                event: 'success',
                timestamp: Date.now(),
                method: 'BiometricPrompt',
                success: 1
            });

            this.onAuthenticationSucceeded(result);
        };

        Callback.onAuthenticationFailed.implementation = function() {
            console.log('[BioShield] [EVENT] ✗ Authentication FAILED');

            writeLog({
                event: 'failed',
                timestamp: Date.now(),
                method: 'BiometricPrompt',
                success: 0
            });

            this.onAuthenticationFailed();
        };

        Callback.onAuthenticationError.implementation = function(errorCode, errString) {
            console.log('[BioShield] [EVENT] ⚠ Authentication ERROR:', errorCode, errString);

            writeLog({
                event: 'error',
                timestamp: Date.now(),
                errorCode: errorCode,
                errorMsg: String(errString),
                method: 'BiometricPrompt',
                success: 0
            });

            this.onAuthenticationError(errorCode, errString);
        };

        console.log('[BioShield] ✓ BiometricPrompt hooks active');
    } catch (error) {
        console.log('[BioShield] ℹ BiometricPrompt not available:', error.message);
    }
}

// ===== Hook legacy FingerprintManager (API < 28) =====
function hookFingerprintManager() {
    try {
        const FingerprintManager = Java.use('android.hardware.fingerprint.FingerprintManager');
        console.log('[BioShield] Found FingerprintManager (legacy API)');

        FingerprintManager.authenticate.overload(
            'android.hardware.fingerprint.FingerprintManager$CryptoObject',
            'android.os.CancellationSignal',
            'int',
            'android.hardware.fingerprint.FingerprintManager$AuthenticationCallback',
            'android.os.Handler'
        ).implementation = function(crypto, cancel, flags, callback, handler) {
            console.log('[BioShield] [HOOK] FingerprintManager.authenticate() called');

            writeLog({
                event: 'fingerprint_auth_started',
                timestamp: Date.now(),
                hasCrypto: (crypto != null),
                flags: flags
            });

            return this.authenticate(crypto, cancel, flags, callback, handler);
        };

        console.log('[BioShield] ✓ FingerprintManager hooks active');
    } catch (error) {
        console.log('[BioShield] ℹ FingerprintManager not available:', error.message);
    }
}

// ===== Create log directory =====
function createLogDirectory() {
    const File = Java.use('java.io.File');
    const dir = File.$new('/storage/emulated/0/Download/BioShield');

    if (!dir.exists()) {
        dir.mkdirs();
        console.log('[BioShield] Created log directory:', dir.getAbsolutePath());
    }
}

// ===== Encrypt and write log entry =====
function writeLog(logData) {
    try {
        // Encrypt the log data
        const encrypted = encryptAESGCM(JSON.stringify(logData));

        // Write to file
        const File = Java.use('java.io.File');
        const FileWriter = Java.use('java.io.FileWriter');
        const BufferedWriter = Java.use('java.io.BufferedWriter');

        const logFile = File.$new(LOG_PATH);
        const fileWriter = FileWriter.$new(logFile, true); // append mode
        const bufferedWriter = BufferedWriter.$new(fileWriter);

        bufferedWriter.write(encrypted);
        bufferedWriter.newLine();
        bufferedWriter.close();

        console.log('[BioShield] [LOG] Encrypted event written to:', LOG_PATH);
    } catch (error) {
        console.error('[BioShield] [ERROR] Failed to write log:', error.message);
    }
}

// ===== AES-256-GCM Encryption =====
function encryptAESGCM(plaintext) {
    try {
        const Cipher = Java.use('javax.crypto.Cipher');
        const SecretKeySpec = Java.use('javax.crypto.spec.SecretKeySpec');
        const GCMParameterSpec = Java.use('javax.crypto.spec.GCMParameterSpec');
        const Base64 = Java.use('android.util.Base64');

        // Decode the key
        const keyBytes = Base64.decode(AES_KEY_B64, 0);
        const secretKey = SecretKeySpec.$new(keyBytes, 'AES');

        // Create IV
        const ivBytes = Java.array('byte', IV);
        const gcmSpec = GCMParameterSpec.$new(128, ivBytes); // 128-bit auth tag

        // Initialize cipher
        const cipher = Cipher.getInstance('AES/GCM/NoPadding');
        cipher.init(1, secretKey, gcmSpec); // 1 = ENCRYPT_MODE

        // Encrypt
        const plaintextBytes = Java.use('java.lang.String').$new(plaintext).getBytes('UTF-8');
        const ciphertext = cipher.doFinal(plaintextBytes);

        // Encode to Base64
        return Base64.encodeToString(ciphertext, 2); // 2 = NO_WRAP
    } catch (error) {
        console.error('[BioShield] [ERROR] Encryption failed:', error.message);
        // Fallback: return plaintext (for debugging only)
        return plaintext;
    }
}

console.log('[BioShield] Hook script loaded successfully');
